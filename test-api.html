<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Test API - Auto-respuestas</title>
    <style>
        body {
            font-family: system-ui;
            padding: 20px;
            background: #0f172a;
            color: #e2e8f0;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #059669;
        }
        pre {
            background: #1e293b;
            padding: 15px;
            border-radius: 5px;
            overflow: auto;
        }
        .error {
            background: #7f1d1d;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            background: #064e3b;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üß™ Test de APIs - Auto-respuestas</h1>

    <div>
        <h2>1. Test Simulador de Bot</h2>
        <button onclick="testSimulator()">Probar: /api/admin/test-auto-reply</button>
        <div id="simulator-result"></div>
    </div>

    <div>
        <h2>2. Test Sugerencias de Reglas</h2>
        <button onclick="testSuggestions()">Probar: /api/admin/rule-suggestions (GET)</button>
        <button onclick="testProcessSuggestions()">Probar: /api/admin/rule-suggestions (POST)</button>
        <div id="suggestions-result"></div>
    </div>

    <script>
        async function testSimulator() {
            const result = document.getElementById('simulator-result');
            result.innerHTML = '<p>Probando...</p>';

            try {
                const res = await fetch('/api/admin/test-auto-reply', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: 'hola' })
                });

                console.log('Response status:', res.status);
                console.log('Response headers:', [...res.headers.entries()]);

                const text = await res.text();
                console.log('Response text:', text);

                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    throw new Error(`No es JSON v√°lido: ${text.substring(0, 200)}`);
                }

                if (data.ok) {
                    result.innerHTML = `
                        <div class="success">‚úÖ Funcion√≥ correctamente</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                } else {
                    result.innerHTML = `
                        <div class="error">‚ùå Error: ${data.error}</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (err) {
                result.innerHTML = `
                    <div class="error">‚ùå Error de red o parsing: ${err.message}</div>
                    <p>Revisa la consola del navegador (F12) para m√°s detalles</p>
                `;
                console.error('Error completo:', err);
            }
        }

        async function testSuggestions() {
            const result = document.getElementById('suggestions-result');
            result.innerHTML = '<p>Probando...</p>';

            try {
                const res = await fetch('/api/admin/rule-suggestions?minOccurrences=5', {
                    credentials: 'same-origin'
                });

                console.log('Response status:', res.status);
                const text = await res.text();
                console.log('Response text:', text);

                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    throw new Error(`No es JSON v√°lido: ${text.substring(0, 200)}`);
                }

                if (data.ok) {
                    result.innerHTML = `
                        <div class="success">‚úÖ Funcion√≥ correctamente</div>
                        <p>Sugerencias encontradas: ${data.items?.length || 0}</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                } else {
                    result.innerHTML = `
                        <div class="error">‚ùå Error: ${data.error}</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (err) {
                result.innerHTML = `
                    <div class="error">‚ùå Error: ${err.message}</div>
                    <p>Revisa la consola del navegador (F12)</p>
                `;
                console.error('Error completo:', err);
            }
        }

        async function testProcessSuggestions() {
            const result = document.getElementById('suggestions-result');
            result.innerHTML = '<p>Procesando sugerencias...</p>';

            try {
                const res = await fetch('/api/admin/rule-suggestions', {
                    method: 'POST',
                    credentials: 'same-origin'
                });

                const text = await res.text();
                let data = JSON.parse(text);

                if (data.ok) {
                    result.innerHTML = `
                        <div class="success">‚úÖ Procesado correctamente</div>
                        <p>Sugerencias generadas: ${data.count || 0}</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                } else {
                    result.innerHTML = `
                        <div class="error">‚ùå Error: ${data.error}</div>
                    `;
                }
            } catch (err) {
                result.innerHTML = `
                    <div class="error">‚ùå Error: ${err.message}</div>
                `;
                console.error(err);
            }
        }

        // Auto-test al cargar
        window.addEventListener('load', () => {
            console.log('P√°gina de test cargada');
            console.log('Cookies:', document.cookie);
        });
    </script>
</body>
</html>
