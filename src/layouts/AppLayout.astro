---
import "../styles/global.css";

const { title = "Mensajer√≠a Web GA" } = Astro.props as { title?: string };
const path = Astro.url.pathname;
const base = import.meta.env.BASE_URL || "/";

const linkBase =
  "group w-12 h-12 grid place-items-center rounded-xl transition";
const idle =
  "text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white hover:bg-slate-200 dark:hover:bg-slate-800";
const active = "text-slate-900 dark:text-white bg-slate-200 dark:bg-slate-800";
const isActive = (href: string) =>
  path === href ||
  path.startsWith(href) ||
  path === `${base}${href}`.replace(/\/\//g, "/") ||
  path.startsWith(`${base}${href}`.replace(/\/\//g, "/"))
    ? active
    : idle;

const user: any = (Astro.locals as any).user;
const isAdmin = (user?.rol || "").toLowerCase() === "admin";
const initial = (user?.nombre || "U").toString().slice(0, 1).toUpperCase();

// Helper to build URLs with base path
const href = (p: string) => `${base}${p}`.replace(/\/\//g, "/");

const mainLinks = [
  { href: "/", icon: "home", label: "Inicio" },
  { href: "/dashboard", icon: "bar-chart-2", label: "Dashboard" },
  { href: "/mensajes", icon: "message-square", label: "Mensajes" },
  { href: "/pipeline", icon: "trello", label: "Pipeline / CRM" },
  { href: "/clientes", icon: "users", label: "Clientes" },
];

const adminLinks = [
  { href: "/admin/usuarios", icon: "user-check", label: "Usuarios" },
  { href: "/admin/asignacion", icon: "share-2", label: "Asignacion" },
  { href: "/admin/auditoria", icon: "eye", label: "Auditoria en vivo" },
  { href: "/admin/crear-plantilla", icon: "file-plus", label: "Plantillas" },
  { href: "/admin/auto-respuestas", icon: "cpu", label: "Auto-respuestas" },
  {
    href: "/admin/mensajes-no-reconocidos",
    icon: "help-circle",
    label: "Mensajes no reconocidos",
  },
  { href: "/admin/estados", icon: "tag", label: "Gesti√≥n de Estados" },
];

const footerLinks = [
  { href: "/config", icon: "settings", label: "Config" },
  { href: "/logout", icon: "log-out", label: "Cerrar sesi√≥n", forceIdle: true },
];
---

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>{title}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/png" href="/logo-gawhats.png" sizes="32x32" />
    <link rel="apple-touch-icon" href="/logo-gawhats.png" />
    <meta name="theme-color" content="#0f172a" />
    <script is:inline>
      // Inicializar tema antes de renderizar para evitar flash
      const theme =
        localStorage.getItem("theme") ||
        (window.matchMedia("(prefers-color-scheme: dark)").matches
          ? "dark"
          : "light");
      document.documentElement.classList.toggle("dark", theme === "dark");
    </script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>

  <body
    class="min-h-screen bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-slate-100"
  >
    <!-- Topbar -->
    <header
      class="fixed top-0 inset-x-0 h-14 z-40 bg-white/90 dark:bg-slate-950/90 backdrop-blur border-b border-slate-200 dark:border-slate-800"
    >
      <div class="h-full max-w-7xl mx-auto px-4 flex items-center gap-3">
        <button
          id="mobile-nav-open"
          class="md:hidden p-2 rounded-lg border border-slate-200 dark:border-slate-800 bg-white/70 dark:bg-slate-900/80 text-slate-700 dark:text-slate-200 hover:border-emerald-400/70 transition"
          aria-label="Abrir men√∫"
        >
          <i data-feather="menu"></i>
        </button>
        <h1 class="text-lg sm:text-xl font-semibold text-emerald-400 truncate">
          {title}
        </h1>
        <div class="ml-auto flex items-center gap-3 min-w-0">
          <!-- Theme Toggle -->
          <div id="theme-toggle-container"></div>
          {
            user && (
              <div class="text-right leading-tight max-w-[200px] sm:max-w-xs">
                <div class="text-sm text-slate-800 dark:text-slate-200 truncate">
                  {user.nombre}
                </div>
                <div class="text-[11px] text-slate-500 dark:text-slate-400 truncate">
                  {user.rol}
                  {user.sucursal ? ` ¬∑ ${user.sucursal}` : ""}
                </div>
              </div>
            )
          }
          <div
            class="w-8 h-8 rounded-full bg-emerald-600/20 border border-emerald-700 grid place-items-center text-emerald-300 text-xs"
          >
            {initial}
          </div>
        </div>
      </div>
    </header>

    <!-- Sidebar -->
    <aside
      class="hidden md:block fixed left-0 top-14 bottom-0 w-16 z-30 bg-white dark:bg-slate-950 border-r border-slate-200 dark:border-slate-800"
    >
      <nav class="h-full flex flex-col items-center py-4 gap-2">
        {
          mainLinks.map((link) => (
            <a
              href={href(link.href)}
              class={`${linkBase} ${isActive(link.href)}`}
              title={link.label}
            >
              <i data-feather={link.icon} />
              <span class="sr-only">{link.label}</span>
            </a>
          ))
        }
        {
          isAdmin &&
            adminLinks.map((link) => (
              <a
                href={href(link.href)}
                class={`${linkBase} ${isActive(link.href)}`}
                title={link.label}
              >
                <i data-feather={link.icon} />
                <span class="sr-only">{link.label}</span>
              </a>
            ))
        }

        <div class="mt-auto"></div>

        {
          footerLinks.map((link) => (
            <a
              href={href(link.href)}
              class={`${linkBase} ${link.forceIdle ? idle : isActive(link.href)}`}
              title={link.label}
            >
              <i data-feather={link.icon} />
              <span class="sr-only">{link.label}</span>
            </a>
          ))
        }
      </nav>
    </aside>

    <!-- Mobile navigation drawer -->
    <div id="mobile-nav" class="md:hidden fixed inset-0 z-50 hidden">
      <div
        class="absolute inset-0 bg-black/60 backdrop-blur-sm"
        data-nav-overlay
      >
      </div>
      <div
        id="mobile-nav-panel"
        class="relative h-full w-[78%] max-w-xs bg-slate-950 border-r border-slate-800 shadow-2xl -translate-x-full transition-transform duration-200"
      >
        <div
          class="h-14 px-4 flex items-center justify-between border-b border-slate-800"
        >
          <div class="text-sm font-semibold text-emerald-300">Men√∫</div>
          <button
            id="mobile-nav-close"
            class="p-2 rounded-lg hover:bg-slate-800 transition"
            aria-label="Cerrar men√∫"
          >
            <i data-feather="x"></i>
          </button>
        </div>
        <div class="p-3 space-y-6 overflow-y-auto h-[calc(100%-3.5rem)]">
          <div class="space-y-1">
            {
              mainLinks.map((link) => (
                <a
                  href={href(link.href)}
                  class={`flex items-center gap-3 px-3 py-2 rounded-lg text-sm ${isActive(link.href)} hover:bg-slate-900/70`}
                >
                  <i data-feather={link.icon} />
                  <span>{link.label}</span>
                </a>
              ))
            }
          </div>

          {
            isAdmin && (
              <div class="space-y-1">
                <div class="text-[11px] uppercase tracking-[0.08em] text-slate-500 px-2">
                  Admin
                </div>
                {adminLinks.map((link) => (
                  <a
                    href={href(link.href)}
                    class={`flex items-center gap-3 px-3 py-2 rounded-lg text-sm ${isActive(link.href)} hover:bg-slate-900/70`}
                  >
                    <i data-feather={link.icon} />
                    <span>{link.label}</span>
                  </a>
                ))}
              </div>
            )
          }

          <div class="space-y-1 pt-2 border-t border-slate-800">
            {
              footerLinks.map((link) => (
                <a
                  href={href(link.href)}
                  class={`flex items-center gap-3 px-3 py-2 rounded-lg text-sm ${link.forceIdle ? idle : isActive(link.href)} hover:bg-slate-900/70`}
                >
                  <i data-feather={link.icon} />
                  <span>{link.label}</span>
                </a>
              ))
            }
          </div>
        </div>
      </div>
    </div>

    <!-- Contenido -->
    <main
      id="page-root"
      class="pt-16 md:pt-14 md:pl-16 pl-0 min-h-screen opacity-0 transition-opacity duration-150"
    >
      <div class="mx-auto px-3 sm:px-4 md:px-5 pb-6">
        <slot />
      </div>
    </main>

    <script src="https://unpkg.com/feather-icons" defer></script>
    <script is:inline define:vars={{ base }}>
      // Icons + page transitions + mobile drawer
      window.addEventListener("DOMContentLoaded", () => {
        window.feather?.replace();

        const root = document.getElementById("page-root");
        if (root)
          requestAnimationFrame(() => root.classList.remove("opacity-0"));

        // Smooth cross-page fade using simple CSS
        const isSameOrigin = (url) => {
          try {
            const u = new URL(url, window.location.href);
            return u.origin === window.location.origin;
          } catch {
            return false;
          }
        };

        document.addEventListener("click", (e) => {
          const a = e.target.closest("a");
          if (!a) return;
          const href = a.getAttribute("href");
          const target = a.getAttribute("target");
          const download = a.hasAttribute("download");
          const modifier =
            e.metaKey || e.ctrlKey || e.shiftKey || e.altKey || e.button !== 0;
          if (!href || target === "_blank" || download || modifier) return;
          if (!isSameOrigin(href)) return;
          if (!root) {
            window.location.href = href;
            return;
          }
          e.preventDefault();

          // Navegaci√≥n m√°s r√°pida: a√±adir timeout de seguridad
          let navigated = false;
          const navigate = () => {
            if (!navigated) {
              navigated = true;
              window.location.href = href;
            }
          };

          root.addEventListener("transitionend", navigate, { once: true });
          // Timeout de seguridad: navegar despu√©s de 200ms aunque la transici√≥n no termine
          setTimeout(navigate, 200);
          root.classList.add("opacity-0");
        });

        const mobileNav = document.getElementById("mobile-nav");
        const mobilePanel = document.getElementById("mobile-nav-panel");
        const openBtn = document.getElementById("mobile-nav-open");
        const closeBtn = document.getElementById("mobile-nav-close");
        const overlay = mobileNav?.querySelector("[data-nav-overlay]");

        const closeMobileNav = () => {
          if (!mobileNav || !mobilePanel) return;
          mobilePanel.classList.add("-translate-x-full");
          setTimeout(() => mobileNav.classList.add("hidden"), 180);
        };

        const openMobileNav = () => {
          if (!mobileNav || !mobilePanel) return;
          mobileNav.classList.remove("hidden");
          requestAnimationFrame(() =>
            mobilePanel.classList.remove("-translate-x-full"),
          );
        };

        openBtn?.addEventListener("click", openMobileNav);
        closeBtn?.addEventListener("click", closeMobileNav);
        overlay?.addEventListener("click", closeMobileNav);
        mobileNav?.addEventListener("keydown", (ev) => {
          if (ev.key === "Escape") closeMobileNav();
        });
        mobileNav
          ?.querySelectorAll("a")
          .forEach((a) => a.addEventListener("click", closeMobileNav));
      });
    </script>

    <!-- Theme Toggle Script -->
    <script>
      const container = document.getElementById("theme-toggle-container");
      if (container) {
        const isDark = document.documentElement.classList.contains("dark");

        const button = document.createElement("button");
        button.className =
          "w-10 h-10 rounded-lg bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 transition flex items-center justify-center text-2xl";
        button.innerHTML = isDark ? "‚òÄÔ∏è" : "üåô";
        button.title = isDark
          ? "Cambiar a modo claro"
          : "Cambiar a modo oscuro";

        button.addEventListener("click", () => {
          const currentlyDark =
            document.documentElement.classList.contains("dark");
          const newTheme = !currentlyDark;

          document.documentElement.classList.toggle("dark", newTheme);
          localStorage.setItem("theme", newTheme ? "dark" : "light");

          button.innerHTML = newTheme ? "‚òÄÔ∏è" : "üåô";
          button.title = newTheme
            ? "Cambiar a modo claro"
            : "Cambiar a modo oscuro";
        });

        container.appendChild(button);
      }
    </script>
  </body>
</html>
